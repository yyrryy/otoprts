{% extends 'base.html' %}
{% load static %}
{% block content %}

<!-- add csfr token -->
{% csrf_token %}

<div class="mt-5 container bg-white">
		
	<div class="salsman col-4">
		SS
	</div>
		
		
	<div class="view-options__body">
		<div class="row pb-3">
			<div class="col-3">
			   <div class="filter-vehicle">
				   <select name="category" id="" class="form-control form-control-select2">
					   <option value="0">Category</option>
					   {% for i in categories %}
					   <option value="{{i.id}}">{{i.title.capitalize}}</option>
					   {% endfor %}
				   </select>
				  
			   </div>
			</div>

			<div class="col-3">
				<div class="filter-vehicle">
					<input type="text" name="brand" class="form-control" placeholder="brand">
					<!-- <select name="brand" id="" class="form-control form-control-select2">
						<option value="0">Car brand</option>
						{% for i in brands %}
						<option value="{{i.id}}">{{i.name.capitalize}}</option>
						{% endfor %}

					</select> -->
				   
				</div>
			</div>
				
			<div class="col-3">
				<div class="filter-vehicle">
					<input type="text" name="model" class="form-control" placeholder="model">
					<!-- <select name="model" id="" class="form-control form-control-select2">
						<option value="0">Car model</option>
						{% for i in models %}
						<option value="{{i.id}}">{{i.name.capitalize}}</option>
						{% endfor %}
					</select> -->
				   
				</div>
			</div>

			<div class="col-3">
				<div class="filter-vehicle">
					<input type="text" name="mark" class="form-control" placeholder="mark">
					<!-- <select name="model" id="" class="form-control form-control-select2">
						<option value="0">Mark</option>
						{% for i in models %}
						<option value="{{i.id}}">{{i.name.capitalize}}</option>
						{% endfor %}
					</select> -->
				   
				</div>
			</div>
		</div>

		<button class="btn btn-primary btn-sm filterbtn w-100">Filter</button>
	</div>

	   <div class="">
		  


		  <div class="block-split__item block-split__item-content col-auto">
			 <div class="block">
				<div class="products-view">
				   <div class="products-view__options view-options view-options--offcanvas--mobile">
					  
				   </div>
				   <div class="products-view__list products-list products-list--grid--4" data-layout="table" data-with-features="false">
					  <!-- <div class="products-list__head">
						 <div class="products-list__column products-list__column--image">Image</div>
						 <div class="products-list__column products-list__column--meta">Ref</div>
						 <div class="products-list__column products-list__column--product">Product</div>
						 <div class="products-list__column products-list__column--price">Price</div>
					  </div>
					  <div class="products-list__content">
						 
					  </div> -->
					  <table class="table table-striped table-borded">
						<thead>
						  <tr>
							<th style="width: 15%">#</th>
							<th >Name</th>
							<th style="width: 10%;">Price</th>
							<th style="width: 5%;">Qty</th>
						  </tr>
						</thead>
						<tbody class="prdctslist">
							
						</tbody>
					  </table>
				   </div>
				   
				</div>
			 </div>
		  </div>

		  <br><br>
		  <p>
			Commande
		  </p>

		  <table class="table table-striped table-borded">
			<thead>
			  <tr>
				<th >ref</th>
				<th style="width:10%;">Qty</th>
			  </tr>
			</thead>
			<tbody class="commande-table">
				
			</tbody>
		  </table>
		  <p>
			Client:
		  </p>
		  <div class="d-flex justify-content-center">

			  <select class="w-25 client form-control form-control-select2" name="client">
				  <option value="0">---</option>
				  {% for i in clients %}
					  <option value="{{i.id}}">{{i.name}} {{i.city}}</option>
				  {% endfor %}
			  </select>
			  
			<button class="btn btn-primary valider" disabled>
			  Confirmer
			</button>
		  </div>
		  <small class="text-danger d-none clienterr">
			choose a client
		</small>
	   </div>


	   <div class="block-space block-space--layout--before-footer"></div>
	</div>
 </div>
{% endblock %}

{% block js %}
<script>
	const client = $('select[name="client"]');
	const tablecmnd = $('.commande-table');
	
	const loading=()=>{
		$('.loading').removeClass('d-none').addClass('d-flex');
        }

    const stoploading=()=>{
        $('.loading').removeClass('d-flex').addClass('d-none');
    }

	const addcmnd=(name, ref, qty)=>{
		$('.valider').prop('disabled', false)
		tablecmnd.append(`
		<tr class="cmndholder">
		<td class="pdctcmnd" ref=${ref} name="${name}">
			${name} - ${ref}
		</td>
		<td class="qtyholder">
			<div class="cart-table__quantity input-number"><input class="form-control input-number__input qty" type="number" min="0" value="${qty}"><div class="input-number__add"></div><div class="input-number__sub"></div></div>
			
		</td>
		
	</tr>
		`)
		$('.input-number').customNumber();
	}

	
	const validercmnd=(clientid)=>{
		holder=$('.cmndholder')
		commande=[]
		holder.each((i, el)=>{
			ref=$(el).find('.pdctcmnd').attr('name')+' - '+$(el).find('.pdctcmnd').attr('ref')
			qty=$(el).find('.qtyholder .input-number > .qty').val()
			cmd=ref+':'+qty
			commande.push(cmd)
		})
		$.ajax({
			url: '/commande',
			type: 'POST',
			data: {
				'csrfmiddlewaretoken': '{{ csrf_token }}',
				'commande': commande,
				'client':clientid
			},
			success: function(data){
				stoploading()
				$('.cmndholder').remove()
				$('.valider').prop('disabled', true)
				// refresh
				location.reload()
			},
			error:(err)=>{
				stoploading()
				alert(err)
			}
		})
	}

	
	const close = function() {

		$('body').css({
			'overflow': 'auto',
			'paddingRight': ''
		});

        const mobileMenu = $('.mobile-menu');

        const mobileMenuBody = mobileMenu.children('.mobile-menu__body');


		$('.sidebar--open').removeClass('sidebar--open')

		mobileMenu.removeClass('mobile-menu--open');

	};
	
	$('.filterbtn').on('click',() => {
				loading()
                let filters= {
                    csrfmiddlewaretoken:$("[name=csrfmiddlewaretoken]").val(),
                    category:$('select[name=category]').val(),
                    brand:$('input[name="brand"]').val(),
                    model:$('input[name="model"]').val(),
                    mark:$('input[name="mark"]').val()
                }
        
                $.ajax({
                    method:'Post',
                    url:'/filters',
                    data:{
                    csrfmiddlewaretoken:$("[name=csrfmiddlewaretoken]").val(),
                    category:$('select[name=category]').val()=='0'?null:+$('select[name=category]').val(),
                    brand:$('input[name="brand"]').val()=='0'?null:$('input[name="brand"]').val(),
                    model:$('input[name="model"]').val()=='0'?null:$('input[name="model"]').val(),
                    mark:$('input[name="mark"]').val()=='0'?null:$('input[name="mark"]').val()
                },
                    success:(data)=>{
						stoploading()
                        $('.prdctslist').html(data.data)
						$('.input-number').customNumber();
						$('.cmnd').each((i, el)=>{
							$(el).on('click', ()=>{
								// id=$(el).attr('pdct');
								$(el).attr('disabled', true)
								ref=$(el).attr('pdctref')
								name=$(el).attr('pdctname')
								console.log(name)
								// get nearest item
								let qty = $(el).parent().find('.input-number > .input-number__input').val()
								addcmnd(name, ref, qty)
							})
						})
					},
                    Error:(error)=>{
						stoploading()
						alert('error')
                        console.log(error)
                    }
        
                })
        
        
            })

	$('.valider').on('click', ()=>{
		clientid=client.val()
		if(clientid=='0'){
			$('.clienterr').removeClass('d-none').addClass('d-block')
			return
			stoploading()
		}
		else{

			$('.clienterr').removeClass('d-block').addClass('d-none')
			validercmnd(clientid)
			stoploading()
		}
	})

</script>
<script>
</script>

{% endblock %}
